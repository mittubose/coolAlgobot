<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="csrf-token" content="{{ csrf_token }}">
    <title>Scalping Bot - Ultra-Compact Dashboard</title>

    <!-- Lucide Icons CDN -->
    <script src="https://unpkg.com/lucide@latest">

        // Initialize top bar on page load
        document.addEventListener('DOMContentLoaded', function() {
            // Restore saved portfolio
            const savedPortfolio = localStorage.getItem('selectedPortfolio') || '1';
            const selector = document.getElementById('topbar-account-selector');
            if (selector) {
                selector.value = savedPortfolio;
            }

            // Mark current page as active
            const currentPath = window.location.pathname;
            document.querySelectorAll('.nav-link').forEach(link => {
                const href = link.getAttribute('href');
                if (href === currentPath || (currentPath === '/' && href === '/')) {
                    link.classList.add('active');
                }
            });

            // Load funds
            loadTopBarFunds();

            // Initialize Lucide icons
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }
        });

    </script>

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

    <!-- Lightweight Charts for Candlesticks -->
    <script src="https://unpkg.com/lightweight-charts/dist/lightweight-charts.standalone.production.js"></script>

    <!-- OMS Client for Real-Time Updates -->
    <script src="{{ url_for('static', filename='js/oms-client.js') }}"></script>

    <style>
        /* Ultra-Compact Design Tokens v2.1 */
        :root {
            /* Colors - Updated to match Groww/Zerodha aesthetic */
            --color-bg-primary: #0F1014;        /* Deeper black */
            --color-bg-secondary: #1C1E26;      /* Sidebar/cards solid */
            --color-bg-tertiary: #2A2D3A;       /* Hover states */

            --color-accent-primary: #00C9A7;    /* Teal (Groww-style) */
            --color-accent-secondary: #6C63FF;  /* Purple accent */

            --color-success: #00D09C;           /* Brighter profit green */
            --color-error: #FF5252;             /* Brighter loss red */
            --color-warning: #FFB946;           /* Brighter warning */
            --color-info: #4A9EFF;              /* Brighter info blue */

            --color-text-primary: #F9FAFB;
            --color-text-secondary: #9CA3AF;
            --color-text-tertiary: #9CA3AF;  /* Changed from #6B7280 for WCAG AA compliance (4.8:1 contrast ratio) */

            --color-border: rgba(255, 255, 255, 0.08);
            --glass-bg: rgba(31, 41, 55, 0.6);
            --glass-border: rgba(255, 255, 255, 0.1);

            /* Ultra-Compact Spacing (2px base) */
            --space-1: 2px;
            --space-2: 4px;
            --space-3: 6px;
            --space-4: 8px;
            --space-5: 12px;
            --space-6: 16px;
            --space-8: 24px;

            /* Card Padding (50% reduction) */
            --card-padding-sm: 8px 12px;
            --card-padding-md: 12px 16px;
            --card-padding-lg: 16px 20px;

            /* Compact Typography */
            --text-2xs: 0.6875rem; /* 11px */
            --text-xs: 0.75rem;    /* 12px */
            --text-sm: 0.8125rem;  /* 13px */
            --text-base: 0.875rem; /* 14px */
            --text-lg: 1rem;       /* 16px */
            --text-xl: 1.125rem;   /* 18px */
            --text-2xl: 1.25rem;   /* 20px */
            --text-3xl: 1.5rem;    /* 24px */

            /* Reduced Border Radius */
            --radius-sm: 4px;
            --radius-md: 6px;
            --radius-lg: 8px;
            --radius-xl: 12px;

            /* Fonts */
            --font-primary: 'Inter', -apple-system, sans-serif;
            --font-mono: 'JetBrains Mono', monospace;

            /* Glassmorphism */
            --glass-blur-light: blur(8px);
            --glass-blur-medium: blur(12px);
            --glass-blur-heavy: blur(16px);
            --glass-bg-subtle: rgba(255, 255, 255, 0.05);
            --glass-bg-light: rgba(255, 255, 255, 0.08);
            --glass-bg-medium: rgba(255, 255, 255, 0.12);
            --glass-border-subtle: rgba(255, 255, 255, 0.08);
            --glass-border-light: rgba(255, 255, 255, 0.12);
            --glass-shadow-md: 0 4px 16px rgba(0, 0, 0, 0.25), 0 2px 4px rgba(0, 0, 0, 0.15);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: var(--font-primary);
            background: var(--color-bg-primary);
            color: var(--color-text-primary);
            font-size: var(--text-base);
            line-height: 1.4;
        }

        /* Accessibility Utilities */
        .visually-hidden {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }

        /* Focus Visible Styles - WCAG 2.1 Compliance */
        *:focus-visible {
            outline: 2px solid var(--color-accent-primary);
            outline-offset: 2px;
            border-radius: var(--radius-sm);
        }

        button:focus-visible,
        a:focus-visible,
        select:focus-visible,
        input:focus-visible {
            outline: 2px solid var(--color-accent-primary);
            outline-offset: 2px;
        }

        /* Skip to main content link (for keyboard navigation) */
        .skip-to-main {
            position: absolute;
            top: -40px;
            left: 0;
            background: var(--color-accent-primary);
            color: var(--color-bg-primary);
            padding: 8px 16px;
            text-decoration: none;
            border-radius: var(--radius-md);
            z-index: 1000;
        }

        .skip-to-main:focus {
            top: 10px;
            left: 10px;
        }

        /* Icon Size Utilities */
        .icon-8 {
            width: 8px;
            height: 8px;
        }

        .icon-12 {
            width: 12px;
            height: 12px;
        }

        .icon-14 {
            width: 14px;
            height: 14px;
        }

        .icon-16 {
            width: 16px;
            height: 16px;
        }

        .icon-18 {
            width: 18px;
            height: 18px;
        }

        .icon-20 {
            width: 20px;
            height: 20px;
        }

        .icon-fill {
            fill: currentColor;
        }

        .icon-accent {
            color: var(--color-accent-primary);
        }

        .icon-tertiary {
            color: var(--color-text-tertiary);
        }

        /* Empty State Utility */
        .empty-state {
            color: var(--color-text-tertiary);
            text-align: center;
            padding: var(--space-4) 0;
            font-size: var(--text-xs);
        }

        .empty-state--large {
            padding: var(--space-8) 0;
            font-size: var(--text-sm);
        }

        .app {
            display: flex;
            min-height: 100vh;
        }

        /* Sidebar (Removed - Using topbar-only layout) */
        .sidebar {
            display: none !important; /* Completely hidden - navigation moved to topbar */
            width: 0;
            background: var(--color-bg-secondary);
            border-right: 1px solid rgba(255, 255, 255, 0.08);
            position: fixed;
            height: 100vh;
            padding: var(--space-6);
            display: flex;
            flex-direction: column;
            z-index: 100;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.3);
            transition: transform 300ms ease-in-out;
        }

        /* Mobile-hidden only applies on mobile screens */
        @media (max-width: 768px) {
            .sidebar.mobile-hidden {
                transform: translateX(-100%);
            }
        }

        .sidebar__logo {
            display: flex;
            align-items: center;
            gap: var(--space-3);
            margin-bottom: var(--space-6);
        }

        .sidebar__logo-icon {
            width: 24px;
            height: 24px;
            background: linear-gradient(135deg, var(--color-accent-primary), var(--color-accent-secondary));
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: var(--text-base);
            color: var(--color-bg-primary);
        }

        .sidebar__logo-text {
            font-size: 15px;
            font-weight: 600;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: var(--space-3);
            padding: var(--space-4) var(--space-5);
            color: var(--color-text-secondary);
            text-decoration: none;
            border-radius: var(--radius-md);
            transition: all 150ms;
            margin-bottom: var(--space-2);
            cursor: pointer;
            border: none;
            background: none;
            width: 100%;
            font-size: var(--text-sm);
        }

        .nav-item:hover {
            background: rgba(255, 255, 255, 0.05);
            color: var(--color-text-primary);
        }

        .nav-item.active {
            background: var(--color-bg-tertiary);
            color: var(--color-accent-primary);
            border: 1px solid var(--color-accent-primary);
        }

        .nav-divider {
            height: 1px;
            background: var(--color-border);
            margin: var(--space-5) 0;
        }

        /* Main Content (Full Width - No Sidebar) */
        .main {
            flex: 1;
            margin-left: 0; /* No sidebar, full width */
            display: flex;
            flex-direction: column;
        }

        /* Top Bar (NEW) */
        .topbar {
            height: 48px;
            background: var(--color-bg-secondary);
            border-bottom: 1px solid var(--color-border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 var(--space-6);
            gap: var(--space-6);
            position: sticky;
            top: 0;
            z-index: 50;
        }

        .topbar__left,
        .topbar__right {
            display: flex;
            align-items: center;
            gap: var(--space-5);
        }

        .hamburger {
            display: none !important; /* Not needed without sidebar */
            display: none;
            width: 32px;
            height: 32px;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background: var(--color-bg-tertiary);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-md);
            cursor: pointer;
            gap: 4px;
            transition: all 150ms;
        }

        .hamburger:hover {
            border-color: var(--color-accent-primary);
        }

        .hamburger__line {
            width: 18px;
            height: 2px;
            background: var(--color-text-primary);
            transition: all 300ms;
            border-radius: 2px;
        }

        .hamburger.active .hamburger__line:nth-child(1) {
            transform: rotate(45deg) translate(4px, 4px);
        }

        .hamburger.active .hamburger__line:nth-child(2) {
            opacity: 0;
        }

        .hamburger.active .hamburger__line:nth-child(3) {
            transform: rotate(-45deg) translate(4px, -4px);
        }

        .topbar__account {
            display: flex;
            align-items: center;
            gap: var(--space-3);
            padding: var(--card-padding-sm);
            background: var(--color-bg-tertiary);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: all 150ms;
            height: 32px;
        }

        .topbar__account:hover {
            border-color: var(--color-accent-primary);
        }

        .topbar__account-icon {
            width: 16px;
            height: 16px;
            color: var(--color-accent-primary);
        }

        .topbar__account-name {
            font-size: var(--text-sm);
            color: var(--color-text-primary);
        }

        .topbar__funds {
            display: flex;
            align-items: center;
            gap: var(--space-3);
            padding: var(--card-padding-sm);
            background: var(--color-bg-tertiary);
            border-radius: var(--radius-md);
            height: 32px;
        }

        .topbar__funds-label {
            font-size: var(--text-2xs);
            color: var(--color-text-tertiary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .topbar__funds-value {
            font-size: var(--text-base);
            font-weight: 600;
            font-family: var(--font-mono);
            color: var(--color-success);
        }

        .topbar__status {
            display: flex;
            align-items: center;
            gap: var(--space-2);
            padding: var(--card-padding-sm);
            background: var(--color-bg-tertiary);
            border-radius: var(--radius-md);
            height: 32px;
        }

        .topbar__status-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        .topbar__status-dot--live {
            background: var(--color-success);
        }

        .topbar__status-dot--offline {
            background: var(--color-error);
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .topbar__status-text {
            font-size: var(--text-xs);
            color: var(--color-text-secondary);
        }

        .topbar__icon-btn {
            position: relative;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--color-bg-tertiary);
            border: 1px solid transparent;
            border-radius: var(--radius-md);
            color: var(--color-text-secondary);
            cursor: pointer;
            transition: all 150ms;
        }

        .topbar__icon-btn:hover {
            border-color: var(--color-accent-primary);
            color: var(--color-text-primary);
        }

        .topbar__badge {
            position: absolute;
            top: -4px;
            right: -4px;
            min-width: 16px;
            height: 16px;
            padding: 0 4px;
            background: var(--color-error);
            color: white;
            font-size: 10px;
            font-weight: 600;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
        }


        /* Logo on Topbar (NEW) */
        .topbar__logo {
            display: flex;
            align-items: center;
            gap: var(--space-3);
            font-weight: 600;
            font-size: var(--text-base);
            color: var(--color-text-primary);
            margin-right: var(--space-6);
        }

        .topbar__logo-icon {
            width: 32px;
            height: 32px;
            background: var(--color-accent-primary);
            color: var(--color-bg-primary);
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: var(--text-base);
        }

        /* Dropdown Menu System (NEW) */
        .dropdown {
            position: relative;
            display: inline-block;
        }

        .dropdown__menu {
            position: absolute;
            top: calc(100% + 8px);
            right: 0;
            min-width: 240px;
            background: var(--color-bg-secondary);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-lg);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4);
            padding: var(--space-2);
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-8px);
            transition: all 200ms cubic-bezier(0.4, 0, 0.2, 1);
        }

        .dropdown__menu.show {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .dropdown__item {
            display: flex;
            align-items: center;
            gap: var(--space-3);
            padding: var(--space-3) var(--space-4);
            color: var(--color-text-secondary);
            text-decoration: none;
            border-radius: var(--radius-md);
            font-size: var(--text-sm);
            transition: all 150ms;
            cursor: pointer;
            border: none;
            background: transparent;
            width: 100%;
            text-align: left;
        }

        .dropdown__item:hover {
            background: var(--color-bg-tertiary);
            color: var(--color-text-primary);
        }

        .dropdown__item.active {
            background: rgba(0, 201, 167, 0.1);
            color: var(--color-accent-primary);
        }

        .dropdown__divider {
            height: 1px;
            background: var(--color-border);
            margin: var(--space-2) 0;
        }

        .dropdown__header {
            padding: var(--space-3) var(--space-4);
            font-size: var(--text-xs);
            font-weight: 600;
            color: var(--color-text-tertiary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Notification Dropdown */
        .notification-dropdown {
            min-width: 360px;
            max-height: 480px;
            overflow-y: auto;
        }

        .notification-item {
            display: flex;
            gap: var(--space-3);
            padding: var(--space-4);
            border-radius: var(--radius-md);
            transition: background 150ms;
            cursor: pointer;
        }

        .notification-item:hover {
            background: var(--color-bg-tertiary);
        }

        .notification-item__icon {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .notification-item__icon--success {
            background: rgba(0, 208, 156, 0.1);
            color: var(--color-success);
        }

        .notification-item__icon--error {
            background: rgba(255, 82, 82, 0.1);
            color: var(--color-error);
        }

        .notification-item__icon--info {
            background: rgba(74, 158, 255, 0.1);
            color: var(--color-info);
        }

        .notification-item__content {
            flex: 1;
            min-width: 0;
        }

        .notification-item__title {
            font-size: var(--text-sm);
            font-weight: 500;
            color: var(--color-text-primary);
            margin-bottom: var(--space-1);
        }

        .notification-item__message {
            font-size: var(--text-xs);
            color: var(--color-text-secondary);
            line-height: 1.4;
        }

        .notification-item__time {
            font-size: var(--text-2xs);
            color: var(--color-text-tertiary);
            margin-top: var(--space-1);
        }

        .notification-empty {
            padding: var(--space-8) var(--space-4);
            text-align: center;
            color: var(--color-text-tertiary);
            font-size: var(--text-sm);
        }

        .notification-footer {
            padding: var(--space-3);
            border-top: 1px solid var(--color-border);
            margin-top: var(--space-2);
        }

        .notification-footer__btn {
            width: 100%;
            padding: var(--space-3);
            background: var(--color-bg-tertiary);
            border: none;
            border-radius: var(--radius-md);
            color: var(--color-accent-primary);
            font-size: var(--text-sm);
            font-weight: 500;
            cursor: pointer;
            transition: all 150ms;
        }

        .notification-footer__btn:hover {
            background: rgba(0, 201, 167, 0.1);
        }

        /* Content Area */
        .content {
            flex: 1;
            padding: var(--space-6);
            overflow-y: auto;
        }

        /* Header (Compact) */
        .header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: var(--space-6);
        }

        .header__title {
            font-size: var(--text-2xl);
            font-weight: 600;
            margin-bottom: var(--space-1);
        }

        .header__subtitle {
            font-size: var(--text-sm);
            color: var(--color-text-secondary);
        }

        .status-badge {
            padding: var(--space-3) var(--space-5);
            border-radius: var(--radius-md);
            font-size: var(--text-xs);
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: var(--space-2);
            border: 1px solid;
        }

        .status-badge--stopped {
            background: rgba(156, 163, 175, 0.1);
            border-color: var(--color-text-tertiary);
            color: var(--color-text-secondary);
        }

        .status-badge--running {
            background: rgba(16, 185, 129, 0.1);
            border-color: var(--color-success);
            color: var(--color-success);
        }

        /* Integration Banner (NEW) */
        .integration-banner {
            display: flex;
            align-items: center;
            gap: var(--space-5);
            padding: var(--card-padding-md);
            border-radius: var(--radius-lg);
            margin-bottom: var(--space-6);
            border: 1px solid;
            background: rgba(245, 158, 11, 0.1);
            border-color: var(--color-warning);
        }

        .integration-banner__icon {
            flex-shrink: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--color-warning);
        }

        .integration-banner__content {
            flex: 1;
        }

        .integration-banner__title {
            font-size: var(--text-base);
            font-weight: 600;
            margin-bottom: var(--space-1);
        }

        .integration-banner__message {
            font-size: var(--text-xs);
            color: var(--color-text-secondary);
        }

        /* Control Panel (Compact) */
        .controls {
            background: var(--color-bg-secondary);
            padding: var(--card-padding-md);
            border-radius: var(--radius-lg);
            margin-bottom: var(--space-6);
            display: flex;
            gap: var(--space-5);
            align-items: center;
            border: 1px solid var(--color-border);
        }

        .btn {
            padding: var(--space-3) var(--space-5);
            border: none;
            border-radius: var(--radius-md);
            font-weight: 600;
            font-size: var(--text-sm);
            cursor: pointer;
            transition: all 150ms;
            display: flex;
            align-items: center;
            gap: var(--space-2);
            height: 32px;
        }

        .btn:hover {
            transform: translateY(-1px);
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--color-accent-primary), var(--color-accent-secondary));
            color: var(--color-bg-primary);
        }

        .btn-primary:hover {
            box-shadow: 0 4px 12px rgba(32, 231, 208, 0.3);
        }

        .btn-secondary {
            background: var(--color-bg-tertiary);
            color: var(--color-text-primary);
            border: 1px solid var(--color-border);
        }

        .btn-danger {
            background: var(--color-error);
            color: white;
        }

        select {
            padding: var(--card-padding-sm);
            background: var(--color-bg-tertiary);
            color: var(--color-text-primary);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-md);
            font-size: var(--text-sm);
            cursor: pointer;
            height: 32px;
        }

        /* Compact Stats Row (NEW) */
        .stats-row {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 0;
            background: var(--color-bg-secondary);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-lg);
            height: 72px;
            padding: var(--card-padding-md);
            margin-bottom: var(--space-6);
        }

        .stat {
            display: flex;
            flex-direction: column;
            justify-content: center;
            gap: var(--space-1);
            padding: 0 var(--space-4);
        }

        .stat__label {
            font-size: var(--text-2xs);
            font-weight: 600;
            color: var(--color-text-tertiary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: var(--space-1);
        }

        .stat__value {
            font-size: var(--text-2xl);
            font-weight: 700;
            font-family: var(--font-mono);
            line-height: 1;
            margin-bottom: var(--space-1);
        }

        .stat__change {
            display: flex;
            align-items: center;
            gap: var(--space-1);
            font-size: var(--text-2xs);
            font-weight: 600;
        }

        .stat__change--up { color: var(--color-success); }
        .stat__change--down { color: var(--color-error); }

        .stat__meta {
            font-size: var(--text-2xs);
            color: var(--color-text-tertiary);
        }

        .stat__divider {
            width: 1px;
            background: var(--color-border);
            margin: var(--space-4) 0;
        }

        /* Compact Chart (Height: 280px) */
        .chart-card {
            background: var(--color-bg-secondary);
            border: 1px solid var(--color-border);
            padding: var(--card-padding-lg);
            border-radius: var(--radius-lg);
            margin-bottom: var(--space-6);
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--space-5);
            height: 28px;
        }

        .chart-header__title {
            font-size: var(--text-lg);
            font-weight: 600;
        }

        .chart-tabs {
            display: flex;
            gap: var(--space-1);
            background: var(--color-bg-tertiary);
            padding: 2px;
            border-radius: var(--radius-md);
        }

        .chart-tab {
            padding: var(--space-2) var(--space-5);
            font-size: var(--text-xs);
            font-weight: 600;
            background: transparent;
            border: none;
            border-radius: var(--radius-sm);
            color: var(--color-text-secondary);
            cursor: pointer;
            transition: all 150ms;
            height: 24px;
        }

        .chart-tab.active {
            background: var(--color-accent-primary);
            color: var(--color-bg-primary);
        }

        .chart-container {
            height: 240px;
            position: relative;
        }

        /* Grid */
        .grid-2 {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: var(--space-5);
            margin-bottom: var(--space-6);
        }

        /* Card (Compact) */
        .card {
            background: var(--glass-bg);
            backdrop-filter: blur(12px);
            border: 1px solid var(--glass-border);
            padding: var(--card-padding-lg);
            border-radius: var(--radius-lg);
            transition: all 150ms;
        }

        .card:hover {
            border-color: var(--color-accent-primary);
            transform: translateY(-2px);
        }

        .card__header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--space-5);
        }

        .card__title {
            font-size: var(--text-lg);
            font-weight: 600;
        }

        /* Table (Compact) */
        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            text-align: left;
            font-size: var(--text-2xs);
            color: var(--color-text-secondary);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            padding: var(--space-3);
            border-bottom: 1px solid var(--color-border);
        }

        td {
            padding: var(--space-4) var(--space-3);
            border-bottom: 1px solid rgba(255, 255, 255, 0.03);
            font-size: var(--text-sm);
        }

        tr:hover {
            background: rgba(255, 255, 255, 0.02);
        }

        .table-symbol {
            font-weight: 600;
        }

        .table-pnl {
            font-weight: 600;
            font-family: var(--font-mono);
        }

        .table-pnl--positive { color: var(--color-success); }
        .table-pnl--negative { color: var(--color-error); }

        /* Logs (Compact) */
        .log-viewer {
            background: #0d1117;
            padding: var(--space-5);
            border-radius: var(--radius-md);
            max-height: 300px;
            overflow-y: auto;
            font-family: var(--font-mono);
            font-size: var(--text-xs);
            line-height: 1.5;
        }

        .log-entry {
            display: flex;
            gap: var(--space-3);
            margin-bottom: var(--space-2);
        }

        .log-timestamp {
            color: var(--color-text-tertiary);
            flex-shrink: 0;
        }

        .log-level {
            flex-shrink: 0;
            font-weight: 600;
        }

        .log-level--INFO { color: var(--color-info); }
        .log-level--SUCCESS { color: var(--color-success); }
        .log-level--WARNING { color: var(--color-warning); }
        .log-level--ERROR { color: var(--color-error); }

        /* Alert */
        .alert {
            padding: var(--card-padding-md);
            border-radius: var(--radius-md);
            margin-bottom: var(--space-5);
            display: flex;
            align-items: flex-start;
            gap: var(--space-3);
            border: 1px solid;
            font-size: var(--text-sm);
        }

        .alert-success {
            background: rgba(16, 185, 129, 0.1);
            border-color: var(--color-success);
            color: var(--color-success);
        }

        .alert-error {
            background: rgba(239, 68, 68, 0.1);
            border-color: var(--color-error);
            color: var(--color-error);
        }

        .alert-warning {
            background: rgba(245, 158, 11, 0.1);
            border-color: var(--color-warning);
            color: var(--color-warning);
        }

        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .fade-in {
            animation: fadeIn 300ms ease-out;
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        ::-webkit-scrollbar-track {
            background: var(--color-bg-secondary);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--color-bg-tertiary);
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--color-border);
        }

        /* Pattern Recognition Widget Styles */
        .pattern-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: var(--space-4) var(--space-5);
            background: var(--glass-bg-light);
            border: 1px solid var(--glass-border-light);
            border-radius: var(--radius-md);
            transition: all 200ms;
        }

        .pattern-item:hover {
            background: var(--glass-bg-medium);
            border-color: var(--color-accent-primary);
            transform: translateX(2px);
        }

        .pattern-item--bullish_reversal,
        .pattern-item--bullish {
            border-left: 3px solid var(--color-success);
        }

        .pattern-item--bearish_reversal,
        .pattern-item--bearish {
            border-left: 3px solid var(--color-error);
        }

        .pattern-item--indecision,
        .pattern-item--continuation {
            border-left: 3px solid var(--color-warning);
        }

        .pattern-item__info {
            display: flex;
            flex-direction: column;
            gap: var(--space-1);
            flex: 1;
        }

        .pattern-item__name {
            font-size: var(--text-base);
            font-weight: 600;
            color: var(--color-text-primary);
            text-transform: capitalize;
        }

        .pattern-item__type {
            font-size: var(--text-2xs);
            color: var(--color-text-tertiary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .pattern-item__description {
            font-size: var(--text-xs);
            color: var(--color-text-secondary);
            margin-top: var(--space-1);
            line-height: 1.4;
        }

        .pattern-item__confidence {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: var(--space-2);
            min-width: 80px;
        }

        .confidence-bar-container {
            width: 60px;
            height: 4px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 2px;
            overflow: hidden;
        }

        .confidence-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--color-accent-primary), var(--color-accent-secondary));
            border-radius: 2px;
            transition: width 300ms ease-out;
        }

        .pattern-item__confidence-value {
            font-size: var(--text-xs);
            font-weight: 600;
            color: var(--color-text-secondary);
            font-family: var(--font-mono);
        }

        /* Indicator Chips */
        .indicator-chip {
            display: flex;
            flex-direction: column;
            padding: var(--space-4) var(--space-5);
            background: var(--glass-bg-light);
            border: 1px solid var(--glass-border-light);
            border-radius: var(--radius-md);
            transition: all 200ms;
        }

        .indicator-chip:hover {
            background: var(--glass-bg-medium);
            transform: translateY(-2px);
        }

        .indicator-chip--bullish {
            border-left: 3px solid var(--color-success);
        }

        .indicator-chip--bearish {
            border-left: 3px solid var(--color-error);
        }

        .indicator-chip--neutral {
            border-left: 3px solid var(--color-text-tertiary);
        }

        .indicator-chip__name {
            font-size: var(--text-2xs);
            font-weight: 600;
            color: var(--color-text-tertiary);
            letter-spacing: 0.5px;
            margin-bottom: var(--space-2);
            text-transform: uppercase;
        }

        .indicator-chip__signal {
            font-size: var(--text-sm);
            color: var(--color-text-primary);
            text-transform: capitalize;
            font-weight: 500;
        }

        /* Chart with Overlay Layout */
        .chart-with-overlay {
            display: grid;
            grid-template-columns: 1fr 320px;
            gap: var(--space-6);
            margin-bottom: var(--space-6);
        }

        .chart-main-card {
            background: var(--color-bg-secondary);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-lg);
            padding: var(--card-padding-lg);
        }

        .chart-main-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--space-5);
        }

        .chart-main-title {
            display: flex;
            align-items: center;
            gap: var(--space-3);
        }

        .chart-symbol {
            font-size: var(--text-xl);
            font-weight: 700;
            color: var(--color-text-primary);
        }

        .chart-timeframe {
            font-size: var(--text-sm);
            color: var(--color-text-tertiary);
        }

        .chart-price-info {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: var(--space-1);
        }

        .chart-current-price {
            font-size: var(--text-2xl);
            font-weight: 700;
            font-family: var(--font-mono);
            color: var(--color-success);
        }

        .chart-price-change {
            font-size: var(--text-sm);
            font-weight: 600;
            color: var(--color-success);
        }

        .chart-container-wrapper {
            height: 450px;
            position: relative;
        }

        #candlestickChart {
            width: 100%;
            height: 100%;
        }

        /* Pattern Overlay Compact */
        .pattern-overlay-compact {
            background: var(--glass-bg);
            backdrop-filter: blur(12px);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius-lg);
            padding: var(--card-padding-lg);
            height: fit-content;
            max-height: 580px;
            overflow-y: auto;
            position: sticky;
            top: var(--space-6);
        }

        .overlay-header-compact {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: var(--space-5);
            padding-bottom: var(--space-4);
            border-bottom: 1px solid var(--color-border);
        }

        .overlay-title-compact {
            display: flex;
            align-items: center;
            gap: var(--space-2);
            font-size: var(--text-lg);
            font-weight: 600;
        }

        .overlay-count {
            font-size: var(--text-xs);
            color: var(--color-text-tertiary);
        }

        .overlay-section-compact {
            margin-bottom: var(--space-5);
        }

        .overlay-section-compact:last-child {
            margin-bottom: 0;
        }

        .overlay-section-title {
            font-size: var(--text-2xs);
            font-weight: 700;
            color: var(--color-text-tertiary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: var(--space-3);
        }

        /* Compact Pattern Cards */
        .pattern-compact {
            display: flex;
            align-items: center;
            gap: var(--space-3);
            padding: var(--space-3) var(--space-4);
            background: rgba(255, 255, 255, 0.03);
            border-left: 3px solid var(--color-success);
            border-radius: var(--radius-sm);
            margin-bottom: var(--space-2);
            transition: all 150ms;
            cursor: pointer;
        }

        .pattern-compact:hover {
            background: rgba(255, 255, 255, 0.06);
            transform: translateX(2px);
        }

        .pattern-compact--bullish {
            border-left-color: var(--color-success);
        }

        .pattern-compact--bearish {
            border-left-color: var(--color-error);
        }

        .pattern-compact--indecision {
            border-left-color: var(--color-warning);
        }

        .pattern-icon {
            font-size: 16px;
            flex-shrink: 0;
        }

        .pattern-compact-info {
            flex: 1;
            min-width: 0;
        }

        .pattern-compact-name {
            font-size: var(--text-sm);
            font-weight: 600;
            color: var(--color-text-primary);
            text-transform: capitalize;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .pattern-compact-type {
            font-size: var(--text-2xs);
            color: var(--color-text-tertiary);
        }

        .pattern-compact-confidence {
            font-size: var(--text-xs);
            font-weight: 700;
            font-family: var(--font-mono);
            color: var(--color-accent-primary);
            flex-shrink: 0;
        }

        /* Compact Indicator Chips */
        .indicator-compact {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: var(--space-2) var(--space-3);
            background: rgba(255, 255, 255, 0.03);
            border-left: 2px solid var(--color-text-tertiary);
            border-radius: var(--radius-sm);
            margin-bottom: var(--space-2);
            transition: all 150ms;
        }

        .indicator-compact:hover {
            background: rgba(255, 255, 255, 0.06);
        }

        .indicator-compact--bullish {
            border-left-color: var(--color-success);
        }

        .indicator-compact--bearish {
            border-left-color: var(--color-error);
        }

        .indicator-compact-name {
            font-size: var(--text-2xs);
            font-weight: 700;
            color: var(--color-text-tertiary);
            text-transform: uppercase;
        }

        .indicator-compact-value {
            display: flex;
            align-items: center;
            gap: var(--space-2);
        }

        .indicator-compact-text {
            font-size: var(--text-xs);
            color: var(--color-text-primary);
            text-transform: capitalize;
        }

        .signal-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            flex-shrink: 0;
        }

        .signal-dot--bullish {
            background: var(--color-success);
        }

        .signal-dot--bearish {
            background: var(--color-error);
        }

        .signal-dot--neutral {
            background: var(--color-text-tertiary);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .sidebar {
                width: 240px;
                z-index: 200;
            }

            .main {
                margin-left: 0;
            }

            .hamburger {
                display: flex;
            }

            .topbar__account,
            .topbar__funds,
            .topbar__status {
                display: none;
            }

            .stats-row {
                grid-template-columns: repeat(2, 1fr);
                height: auto;
                padding: var(--space-5);
                gap: var(--space-5);
            }

            .stat__divider {
                display: none;
            }

            .grid-2 {
                grid-template-columns: 1fr;
            }

            .content {
                padding: var(--space-5);
            }

            .chart-container {
                height: 200px;
            }

            .chart-with-overlay {
                grid-template-columns: 1fr;
            }

            .pattern-overlay-compact {
                max-height: none;
                position: relative;
                top: 0;
            }

            .chart-container-wrapper {
                height: 300px;
            }
        }

        /* ==================== Watchlist & Top Picks Styles ==================== */

        /* Watchlist Panel (Collapsible Bottom) */
        .watchlist-panel {
            position: fixed;
            bottom: 0;
            left: 240px;
            right: 0;
            background: var(--glass-bg);
            backdrop-filter: var(--glass-blur-medium);
            border-top: 1px solid var(--glass-border);
            z-index: 100;
            transition: transform 0.3s ease;
        }

        .watchlist-toggle {
            padding: var(--space-4) var(--space-6);
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--glass-bg-light);
            border-bottom: 1px solid var(--glass-border-subtle);
            user-select: none;
        }

        .watchlist-toggle:hover {
            background: var(--glass-bg-medium);
        }

        .watchlist-count {
            background: var(--color-accent-primary);
            color: var(--color-bg-primary);
            padding: 2px 8px;
            border-radius: 12px;
            font-size: var(--text-xs);
            font-weight: 600;
        }

        .watchlist-content {
            max-height: 300px;
            overflow-y: auto;
            padding: var(--space-6);
        }

        .watchlist-content.collapsed {
            display: none;
        }

        .watchlist-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--space-5);
        }

        .watchlist-header h3 {
            font-size: var(--text-lg);
            font-weight: 600;
        }

        .watchlist-actions {
            display: flex;
            gap: var(--space-4);
        }

        .watchlist-input {
            padding: var(--space-3) var(--space-5);
            background: var(--color-bg-tertiary);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius-md);
            color: var(--color-text-primary);
            font-size: var(--text-sm);
            width: 250px;
        }

        .watchlist-input:focus {
            outline: none;
            border-color: var(--color-accent-primary);
        }

        .watchlist-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: var(--space-4);
        }

        .watchlist-item {
            background: var(--color-bg-tertiary);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius-md);
            padding: var(--space-5);
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.2s;
        }

        .watchlist-item:hover {
            border-color: var(--color-accent-primary);
            background: var(--glass-bg-light);
        }

        .watchlist-item-info {
            flex: 1;
        }

        .watchlist-symbol {
            font-size: var(--text-base);
            font-weight: 600;
            color: var(--color-text-primary);
            margin-bottom: var(--space-2);
        }

        .watchlist-price {
            font-size: var(--text-sm);
            color: var(--color-text-secondary);
        }

        .watchlist-change {
            font-size: var(--text-xs);
            font-weight: 600;
            margin-left: var(--space-3);
        }

        .watchlist-change.positive {
            color: var(--color-success);
        }

        .watchlist-change.negative {
            color: var(--color-error);
        }

        .watchlist-pattern-badge {
            display: inline-block;
            padding: 2px 6px;
            border-radius: var(--radius-sm);
            font-size: var(--text-2xs);
            font-weight: 600;
            margin-top: var(--space-2);
        }

        .watchlist-pattern-badge.bullish {
            background: rgba(16, 185, 129, 0.2);
            color: var(--color-success);
        }

        .watchlist-item-actions {
            display: flex;
            gap: var(--space-3);
        }

        .watchlist-remove-btn {
            background: var(--color-error);
            color: white;
            border: none;
            border-radius: var(--radius-sm);
            padding: var(--space-2) var(--space-4);
            cursor: pointer;
            font-size: var(--text-xs);
            transition: opacity 0.2s;
        }

        .watchlist-remove-btn:hover {
            opacity: 0.8;
        }

        /* Top Picks Card */
        .top-picks-list {
            display: flex;
            flex-direction: column;
            gap: var(--space-4);
        }

        .top-pick-item {
            background: var(--color-bg-tertiary);
            border: 1px solid var(--glass-border);
            border-left: 3px solid var(--color-success);
            border-radius: var(--radius-md);
            padding: var(--space-5);
            transition: all 0.2s;
        }

        .top-pick-item:hover {
            border-left-color: var(--color-accent-primary);
            background: var(--glass-bg-light);
        }

        .top-pick-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--space-4);
        }

        .top-pick-symbol {
            font-size: var(--text-lg);
            font-weight: 700;
            color: var(--color-text-primary);
        }

        .top-pick-confidence {
            background: var(--color-success);
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: var(--text-xs);
            font-weight: 600;
        }

        .top-pick-details {
            display: flex;
            gap: var(--space-6);
            font-size: var(--text-sm);
            color: var(--color-text-secondary);
        }

        .top-pick-detail {
            display: flex;
            flex-direction: column;
            gap: var(--space-1);
        }

        .top-pick-detail-label {
            font-size: var(--text-xs);
            color: var(--color-text-tertiary);
            text-transform: uppercase;
        }

        .top-pick-detail-value {
            font-weight: 600;
            color: var(--color-text-primary);
        }

        .top-pick-pattern {
            margin-top: var(--space-4);
            padding-top: var(--space-4);
            border-top: 1px solid var(--glass-border-subtle);
            font-size: var(--text-sm);
            color: var(--color-text-secondary);
        }

        .loading-spinner {
            text-align: center;
            padding: var(--space-8);
            color: var(--color-text-tertiary);
        }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            .watchlist-panel {
                left: 0;
            }

            .watchlist-list {
                grid-template-columns: 1fr;
            }

            .watchlist-input {
                width: 150px;
            }

            .watchlist-actions {
                flex-wrap: wrap;
            }
        }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            .topbar {
                flex-wrap: wrap;
                height: auto;
                padding: 12px;
            }

            .topbar-nav {
                order: 3;
                width: 100%;
                margin-top: 12px;
                justify-content: flex-start;
                overflow-x: auto;
            }

            .topbar-actions {
                gap: 8px;
            }

            .funds-label,
            .topbar-status {
                display: none;
            }
        }

    </style>
</head>
<body>
    <a href="#main-content" class="skip-to-main">Skip to main content</a>
    <div class="app">

        <!-- Main Content -->
        <main class="main" id="main-content">
            <!-- Top Bar -->
            <header class="topbar" role="banner">
                <div class="topbar__left">
                    <!-- Logo (NEW) -->
                    <a href="/" class="topbar__logo" style="text-decoration: none; color: inherit; cursor: pointer;">
                        <div class="topbar__logo-icon">S</div>
                        <span>Scalping Bot</span>
                    </a>
                    <button class="hamburger" id="hamburgerBtn" onclick="toggleMobileSidebar()" aria-label="Toggle mobile navigation menu" aria-expanded="false">
                        <div class="hamburger__line"></div>
                        <div class="hamburger__line"></div>
                        <div class="hamburger__line"></div>
                    </button>

                    <div class="topbar__account" role="button" tabindex="0" aria-label="Account selector: Zerodha">
                        <i data-lucide="building" class="topbar__account-icon" aria-hidden="true"></i>
                        <span class="topbar__account-name">Zerodha</span>
                        <i data-lucide="chevron-down" class="icon-14 icon-tertiary" aria-hidden="true"></i>
                    </div>

                    <div class="topbar__funds" role="status" aria-label="Available funds">
                        <span class="topbar__funds-label">Available</span>
                        <span class="topbar__funds-value" id="topbarFunds" aria-live="polite">100,000</span>
                    </div>

                    <div class="topbar__status" role="status" aria-label="Bot status">
                        <span class="topbar__status-dot topbar__status-dot--offline" id="topbarStatusDot" aria-hidden="true"></span>
                        <span class="topbar__status-text" id="topbarStatusText" aria-live="polite">Offline</span>
                    </div>
                </div>

                <div class="topbar__right">
                    <!-- Notification Dropdown (NEW) -->
                    <div class="dropdown">
                        <button class="topbar__icon-btn" onclick="toggleDropdown('notificationDropdown')" aria-label="Notifications">
                            <i data-lucide="bell" class="icon-18"></i>
                            <span class="topbar__badge" id="notification-count">0</span>
                        </button>
                        <div class="dropdown__menu notification-dropdown" id="notificationDropdown">
                            <div class="dropdown__header">Notifications</div>
                            <div class="notification-empty" id="notificationList">
                                No new notifications
                            </div>
                            <div class="notification-footer">
                                <button class="notification-footer__btn" onclick="window.location.href='/notifications'">
                                    View All Notifications
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Profile Dropdown (NEW) -->
                    <div class="dropdown">
                        <button class="topbar__icon-btn" onclick="toggleDropdown('profileDropdown')" aria-label="User Profile">
                            <i data-lucide="user" class="icon-18"></i>
                        </button>
                        <div class="dropdown__menu" id="profileDropdown">
                            <a href="/" class="dropdown__item active">
                                <i data-lucide="layout-dashboard" class="icon-16"></i>
                                <span>Dashboard</span>
                            </a>
                            <a href="/accounts" class="dropdown__item">
                                <i data-lucide="wallet" class="icon-16"></i>
                                <span>Accounts</span>
                            </a>
                            <a href="/strategies" class="dropdown__item">
                                <i data-lucide="brain" class="icon-16"></i>
                                <span>Strategies</span>
                            </a>
                            <a href="/analytics" class="dropdown__item">
                                <i data-lucide="bar-chart-3" class="icon-16"></i>
                                <span>Analytics</span>
                            </a>
                            <div class="dropdown__divider"></div>
                            <a href="/settings" class="dropdown__item">
                                <i data-lucide="settings" class="icon-16"></i>
                                <span>Settings</span>
                            </a>
                            <a href="/implementation-log" class="dropdown__item">
                                <i data-lucide="list-checks" class="icon-16"></i>
                                <span>Implementation Log</span>
                            </a>
                            <a href="/help" class="dropdown__item">
                                <i data-lucide="help-circle" class="icon-16"></i>
                                <span>Help</span>
                            </a>
                        </div>
                    </div>
                </div>
            </header>

            <!-- Content Area -->
            <div class="content">
                <!-- Header -->
                <div class="header">
                    <div>
                        <h1 class="header__title">Welcome back, Trader</h1>
                        <p class="header__subtitle">Here's what's happening with your bot today</p>
                    </div>
                    <span class="status-badge status-badge--stopped" id="statusBadge">
                        <i data-lucide="circle" class="icon-8 icon-fill" aria-hidden="true"></i>
                        Stopped
                    </span>
                </div>

                <!-- Integration Banner -->
                <div class="integration-banner" id="integrationBanner">
                    <div class="integration-banner__icon">
                        <i data-lucide="alert-triangle" class="icon-20" aria-hidden="true"></i>
                    </div>
                    <div class="integration-banner__content">
                        <h4 class="integration-banner__title">Authentication Required</h4>
                        <p class="integration-banner__message">Connect to Zerodha to start trading with real-time data</p>
                    </div>
                    <a href="/accounts" class="btn btn-primary">
                        <i data-lucide="link" class="icon-16" aria-hidden="true"></i>
                        Connect Now
                    </a>
                </div>

                <!-- Controls -->
                <div class="controls fade-in" role="group" aria-label="Trading bot controls">
                    <label for="modeSelect" class="visually-hidden">Trading Mode</label>
                    <select id="modeSelect" aria-label="Select trading mode">
                        <option value="paper">Paper Trading</option>
                        <option value="live">Live Trading</option>
                    </select>

                    <button class="btn btn-primary" onclick="startBot()" aria-label="Start trading bot">
                        <i data-lucide="play" class="icon-16" aria-hidden="true"></i>
                        <span>Start</span>
                    </button>
                    <button class="btn btn-secondary" onclick="pauseBot()" aria-label="Pause trading bot">
                        <i data-lucide="pause" class="icon-16" aria-hidden="true"></i>
                        <span>Pause</span>
                    </button>
                    <button class="btn btn-secondary" onclick="stopBot()" aria-label="Stop trading bot">
                        <i data-lucide="square" class="icon-16" aria-hidden="true"></i>
                        <span>Stop</span>
                    </button>
                    <button class="btn btn-danger" onclick="emergencyStop()" aria-label="Emergency stop - cancel all orders and close positions">
                        <i data-lucide="alert-triangle" class="icon-16" aria-hidden="true"></i>
                        <span>Emergency Stop</span>
                    </button>
                </div>

                <!-- Alert Area -->
                <div id="alertArea"></div>

                <!-- Compact Stats Row -->
                <div class="stats-row fade-in" role="region" aria-label="Trading statistics">
                    <div class="stat" role="group" aria-labelledby="daily-pnl-label">
                        <div class="stat__label" id="daily-pnl-label">DAILY P&L</div>
                        <div class="stat__value" id="dailyPnl" aria-live="polite">0.00</div>
                        <div class="stat__change stat__change--up" id="dailyChange" aria-live="polite">
                            <i data-lucide="trending-up" class="icon-12" aria-hidden="true"></i>
                            <span>0.0%</span>
                        </div>
                    </div>

                    <div class="stat__divider" role="separator"></div>

                    <div class="stat" role="group" aria-labelledby="total-pnl-label">
                        <div class="stat__label" id="total-pnl-label">TOTAL P&L</div>
                        <div class="stat__value" id="totalPnl" aria-live="polite">0.00</div>
                        <div class="stat__meta">All Time</div>
                    </div>

                    <div class="stat__divider" role="separator"></div>

                    <div class="stat" role="group" aria-labelledby="win-rate-label">
                        <div class="stat__label" id="win-rate-label">WIN RATE</div>
                        <div class="stat__value" id="winRate" aria-live="polite">0.0%</div>
                        <div class="stat__meta" id="winStats" aria-live="polite">0/0 trades</div>
                    </div>

                    <div class="stat__divider" role="separator"></div>

                    <div class="stat" role="group" aria-labelledby="trades-label">
                        <div class="stat__label" id="trades-label">TRADES</div>
                        <div class="stat__value" id="todayTrades" aria-live="polite">0</div>
                        <div class="stat__meta">Today</div>
                    </div>
                </div>

                <!-- Candlestick Chart with Pattern Overlay -->
                <div class="chart-with-overlay fade-in">
                    <!-- Left: Candlestick Chart -->
                    <div class="chart-main-card">
                        <div class="chart-main-header">
                            <div class="chart-main-title">
                                <span class="chart-symbol" id="chartSymbol">NIFTY 50</span>
                                <span class="chart-timeframe" id="chartTimeframe"> 5m</span>
                            </div>
                            <div class="chart-price-info">
                                <span class="chart-current-price" id="chartCurrentPrice">50,000</span>
                                <span class="chart-price-change" id="chartPriceChange">+0.00%</span>
                            </div>
                        </div>
                        <div class="chart-container-wrapper">
                            <div id="candlestickChart"></div>
                        </div>
                    </div>

                    <!-- Right: Pattern Overlay (Compact) -->
                    <div class="pattern-overlay-compact">
                        <div class="overlay-header-compact">
                            <div class="overlay-title-compact">
                                <i data-lucide="brain" class="icon-18 icon-accent" aria-hidden="true"></i>
                                <span>Patterns</span>
                            </div>
                            <span class="overlay-count" id="patternCountCompact">0</span>
                        </div>

                        <!-- Candlestick Patterns (Compact) -->
                        <div class="overlay-section-compact">
                            <div class="overlay-section-title">Candlestick</div>
                            <div id="candlestickPatternsCompact">
                                <p class="empty-state">
                                    No patterns
                                </p>
                            </div>
                        </div>

                        <!-- Technical Indicators (Compact) -->
                        <div class="overlay-section-compact">
                            <div class="overlay-section-title">Indicators</div>
                            <div id="indicatorSignalsCompact">
                                <p class="empty-state">
                                    Loading...
                                </p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Performance Overview Chart (Chart.js) -->
                <div class="chart-card fade-in">
                    <div class="chart-header">
                        <h3 class="chart-header__title">Performance Overview</h3>
                        <div class="chart-tabs">
                            <button class="chart-tab active">1H</button>
                            <button class="chart-tab">1D</button>
                            <button class="chart-tab">1W</button>
                            <button class="chart-tab">1M</button>
                        </div>
                    </div>
                    <div class="chart-container">
                        <canvas id="performanceChart"></canvas>
                    </div>
                </div>

                <!-- Positions & Trades -->
                <div class="grid-2">
                    <!-- Current Positions -->
                    <div class="card fade-in">
                        <div class="card__header">
                            <h3 class="card__title">Current Positions</h3>
                            <button class="topbar__icon-btn" aria-label="Refresh positions">
                                <i data-lucide="refresh-cw" class="icon-16" aria-hidden="true"></i>
                            </button>
                        </div>
                        <div id="positionsContent">
                            <p class="empty-state empty-state--large">
                                No active positions
                            </p>
                        </div>
                    </div>

                    <!-- Recent Trades -->
                    <div class="card fade-in">
                        <div class="card__header">
                            <h3 class="card__title">Recent Trades</h3>
                            <button class="topbar__icon-btn" aria-label="Download trade history">
                                <i data-lucide="download" class="icon-16" aria-hidden="true"></i>
                            </button>
                        </div>
                        <div id="tradesContent">
                            <p class="empty-state empty-state--large">
                                No trades yet
                            </p>
                        </div>
                    </div>
                </div>

                <!-- Today's Top Picks -->
                <div class="card fade-in" id="topPicksCard">
                    <div class="card__header">
                        <h3 class="card__title"> Today's Top Picks</h3>
                        <button class="btn btn--secondary btn--sm" onclick="refreshTopPicks()">
                            <i data-lucide="refresh-cw"></i>
                            Refresh
                        </button>
                    </div>
                    <div id="topPicksList" class="top-picks-list">
                        <div class="loading-spinner">Loading recommendations...</div>
                    </div>
                </div>

                <!-- Logs -->
                <div class="card fade-in">
                    <div class="card__header">
                        <h3 class="card__title">Live Logs</h3>
                        <div class="chart-tabs">
                            <button class="chart-tab active" onclick="switchLogTab('system')">System</button>
                            <button class="chart-tab" onclick="switchLogTab('trades')">Trades</button>
                            <button class="chart-tab" onclick="switchLogTab('errors')">Errors</button>
                        </div>
                    </div>
                    <div class="log-viewer" id="logViewer">
                        <div class="log-entry">
                            <span class="log-timestamp">00:00:00</span>
                            <span class="log-level log-level--INFO">[INFO]</span>
                            <span>Dashboard initialized and ready</span>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <!-- Watchlist (Collapsible Bottom Panel) -->
        <div class="watchlist-panel" id="watchlistPanel">
            <div class="watchlist-toggle" onclick="toggleWatchlist()">
                <span id="watchlistToggleText"> WATCHLIST</span>
                <span class="watchlist-count" id="watchlistCount">0</span>
            </div>
            <div class="watchlist-content" id="watchlistContent">
                <div class="watchlist-header">
                    <h3>My Watchlist</h3>
                    <div class="watchlist-actions">
                        <input type="text" id="addStockInput" placeholder="Enter symbol (e.g., RELIANCE)" class="watchlist-input">
                        <button class="btn btn--primary btn--sm" onclick="addToWatchlist()">
                            <i data-lucide="plus"></i>
                            Add
                        </button>
                    </div>
                </div>
                <div class="watchlist-list" id="watchlistList">
                    <div class="loading-spinner">Loading watchlist...</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // XSS Sanitization Utilities
        const sanitizeHTML = (() => {
            const tagWhitelist = ['b', 'i', 'em', 'strong', 'span', 'div', 'p', 'br'];
            const attrWhitelist = ['class', 'id', 'data-lucide', 'aria-hidden', 'aria-label'];

            // Escape HTML special characters
            const escapeHTML = (str) => {
                const div = document.createElement('div');
                div.textContent = str;
                return div.innerHTML;
            };

            // Sanitize HTML string
            const sanitize = (dirty) => {
                if (typeof dirty !== 'string') return '';

                // Create a temporary element
                const temp = document.createElement('div');
                temp.innerHTML = dirty;

                // Recursively clean elements
                const clean = (node) => {
                    // Text nodes are safe
                    if (node.nodeType === 3) return node.cloneNode();

                    // Only allow whitelisted tags
                    if (node.nodeType === 1) {
                        const tagName = node.tagName.toLowerCase();
                        if (!tagWhitelist.includes(tagName)) {
                            // If tag not allowed, return its text content
                            return document.createTextNode(node.textContent);
                        }

                        const cleanNode = document.createElement(tagName);

                        // Only copy whitelisted attributes
                        Array.from(node.attributes).forEach(attr => {
                            if (attrWhitelist.includes(attr.name)) {
                                cleanNode.setAttribute(attr.name, attr.value);
                            }
                        });

                        // Recursively clean children
                        Array.from(node.childNodes).forEach(child => {
                            const cleanChild = clean(child);
                            if (cleanChild) cleanNode.appendChild(cleanChild);
                        });

                        return cleanNode;
                    }

                    return null;
                };

                const cleanDiv = document.createElement('div');
                Array.from(temp.childNodes).forEach(child => {
                    const cleanChild = clean(child);
                    if (cleanChild) cleanDiv.appendChild(cleanChild);
                });

                return cleanDiv.innerHTML;
            };

            return { escape: escapeHTML, sanitize };
        })();

        // Initialize Lucide icons
        lucide.createIcons();

        let currentLogType = 'system';
        let performanceChart = null;
        let candlestickChart = null;
        let candlestickSeries = null;
        let chartMarkers = [];

        // Initialize Candlestick Chart (Lightweight Charts)
        function initCandlestickChart() {
            const chartContainer = document.getElementById('candlestickChart');
            if (!chartContainer) return;

            // Create chart
            candlestickChart = LightweightCharts.createChart(chartContainer, {
                width: chartContainer.clientWidth,
                height: 450,
                layout: {
                    background: { color: '#0A0E14' },
                    textColor: '#9CA3AF'
                },
                grid: {
                    vertLines: { color: 'rgba(255, 255, 255, 0.04)' },
                    horzLines: { color: 'rgba(255, 255, 255, 0.04)' }
                },
                crosshair: {
                    mode: LightweightCharts.CrosshairMode.Normal
                },
                rightPriceScale: {
                    borderColor: 'rgba(255, 255, 255, 0.08)'
                },
                timeScale: {
                    borderColor: 'rgba(255, 255, 255, 0.08)',
                    timeVisible: true,
                    secondsVisible: false
                }
            });

            // Add candlestick series (Groww-style colors)
            candlestickSeries = candlestickChart.addCandlestickSeries({
                upColor: '#00D09C',
                downColor: '#FF5252',
                borderUpColor: '#00D09C',
                borderDownColor: '#FF5252',
                wickUpColor: '#00D09C',
                wickDownColor: '#FF5252'
            });

            // Load initial data
            updateCandlestickData();

            // Handle window resize
            window.addEventListener('resize', () => {
                if (candlestickChart && chartContainer) {
                    candlestickChart.applyOptions({
                        width: chartContainer.clientWidth
                    });
                }
            });
        }

        // Update Candlestick Chart Data
        function updateCandlestickData() {
            fetch('/api/chart/ohlc?count=100&timeframe=5m&trend=sideways')
                .then(r => r.json())
                .then(data => {
                    if (!data.success || !data.candles) {
                        console.error('Failed to load OHLC data');
                        return;
                    }

                    // Convert candles to Lightweight Charts format
                    const formattedData = data.candles.map(candle => ({
                        time: candle.time,
                        open: candle.open,
                        high: candle.high,
                        low: candle.low,
                        close: candle.close
                    }));

                    // Update series
                    if (candlestickSeries) {
                        candlestickSeries.setData(formattedData);
                    }

                    // Update price info
                    const lastCandle = data.candles[data.candles.length - 1];
                    updatePriceInfo(lastCandle, data.candles[data.candles.length - 2]);

                    // Fetch and add pattern markers
                    addPatternMarkers(data.candles);
                })
                .catch(e => console.error('OHLC update failed:', e));
        }

        // Update Price Information
        function updatePriceInfo(current, previous) {
            if (!current) return;

            const priceElement = document.getElementById('chartCurrentPrice');
            const changeElement = document.getElementById('chartPriceChange');

            priceElement.textContent = `${current.close.toFixed(2)}`;

            if (previous) {
                const change = ((current.close - previous.close) / previous.close) * 100;
                const changeText = change >= 0 ? `+${change.toFixed(2)}%` : `${change.toFixed(2)}%`;
                changeElement.textContent = changeText;
                changeElement.style.color = change >= 0 ? '#00D09C' : '#FF5252';
                priceElement.style.color = change >= 0 ? '#00D09C' : '#FF5252';
            }
        }

        // Add Pattern Markers to Chart
        function addPatternMarkers(candles) {
            // Get pattern data
            fetch('/api/patterns/all')
                .then(r => r.json())
                .then(data => {
                    if (!data.success || !data.candlestick_patterns) return;

                    // Clear existing markers
                    chartMarkers = [];

                    // Add marker for each pattern
                    data.candlestick_patterns.forEach(pattern => {
                        const lastCandle = candles[candles.length - 1];

                        const isBullish = pattern.type.includes('bullish');
                        const isBearish = pattern.type.includes('bearish');

                        chartMarkers.push({
                            time: lastCandle.time,
                            position: isBullish ? 'belowBar' : 'aboveBar',
                            color: isBullish ? '#10B981' : (isBearish ? '#EF4444' : '#F59E0B'),
                            shape: isBullish ? 'arrowUp' : (isBearish ? 'arrowDown' : 'circle'),
                            text: `${pattern.name} (${pattern.confidence}%)`,
                            size: 1
                        });
                    });

                    // Set markers on series
                    if (candlestickSeries && chartMarkers.length > 0) {
                        candlestickSeries.setMarkers(chartMarkers);
                    }
                })
                .catch(e => console.error('Pattern marker update failed:', e));
        }

        // Initialize Chart (Compact 240px height)
        function initChart() {
            const ctx = document.getElementById('performanceChart');
            if (!ctx) return;

            const gradient = ctx.getContext('2d').createLinearGradient(0, 0, 0, 240);
            gradient.addColorStop(0, 'rgba(32, 231, 208, 0.2)');
            gradient.addColorStop(1, 'rgba(32, 231, 208, 0)');

            performanceChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: ['9:15', '10:00', '11:00', '12:00', '13:00', '14:00', '15:00', '15:30'],
                    datasets: [{
                        label: 'P&L',
                        data: [0, 150, -50, 200, 350, 300, 450, 500],
                        borderColor: '#20E7D0',
                        backgroundColor: gradient,
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4,
                        pointRadius: 0,
                        pointHoverRadius: 5,
                        pointHoverBackgroundColor: '#20E7D0',
                        pointHoverBorderColor: '#0A0E14',
                        pointHoverBorderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            backgroundColor: 'rgba(31, 41, 55, 0.95)',
                            titleColor: '#F9FAFB',
                            bodyColor: '#9CA3AF',
                            borderColor: 'rgba(255, 255, 255, 0.1)',
                            borderWidth: 1,
                            padding: 10,
                            displayColors: false,
                            titleFont: { size: 12 },
                            bodyFont: { size: 11 }
                        }
                    },
                    scales: {
                        x: {
                            grid: {
                                color: 'rgba(255, 255, 255, 0.04)',
                                drawBorder: false
                            },
                            ticks: {
                                color: '#6B7280',
                                font: { size: 10 }
                            }
                        },
                        y: {
                            grid: {
                                color: 'rgba(255, 255, 255, 0.04)',
                                drawBorder: false
                            },
                            ticks: {
                                color: '#6B7280',
                                font: { size: 10 },
                                callback: (value) => '' + value
                            }
                        }
                    },
                    interaction: {
                        mode: 'nearest',
                        axis: 'x',
                        intersect: false
                    }
                }
            });
        }

        // Update Dashboard
        function updateDashboard() {
            fetch('/api/status')
                .then(r => r.json())
                .then(data => {
                    // Update status badge
                    const badge = document.getElementById('statusBadge');
                    badge.className = `status-badge status-badge--${data.status}`;
                    badge.innerHTML = `
                        <i data-lucide="circle" class="icon-8 icon-fill" aria-hidden="true"></i>
                        ${data.status.charAt(0).toUpperCase() + data.status.slice(1)}
                    `;

                    // Update topbar status
                    const statusDot = document.getElementById('topbarStatusDot');
                    const statusText = document.getElementById('topbarStatusText');
                    if (data.status === 'running') {
                        statusDot.className = 'topbar__status-dot topbar__status-dot--live';
                        statusText.textContent = 'Live';
                    } else {
                        statusDot.className = 'topbar__status-dot topbar__status-dot--offline';
                        statusText.textContent = 'Offline';
                    }

                    lucide.createIcons();

                    // Update stats
                    updateStatValue('dailyPnl', data.pnl.daily);
                    updateStatValue('totalPnl', data.pnl.total);
                    document.getElementById('winRate').textContent = data.stats.win_rate.toFixed(1) + '%';
                    document.getElementById('winStats').textContent =
                        `${data.stats.winning_trades}/${data.stats.total_trades} trades`;
                    document.getElementById('todayTrades').textContent = data.stats.total_trades;

                    // Update positions and trades
                    updatePositions(data.positions);
                    updateTrades(data.trades);

                    // Hide integration banner if authenticated
                    if (data.authenticated) {
                        document.getElementById('integrationBanner').style.display = 'none';
                    }
                })
                .catch(e => console.error('Update failed:', e));
        }

        // Update Pattern Overlay (Compact Version)
        function updatePatterns() {
            fetch('/api/patterns/all')
                .then(r => r.json())
                .then(data => {
                    if (!data.success) {
                        console.error('Pattern fetch failed:', data.error);
                        return;
                    }

                    // Update pattern count (compact)
                    const totalPatterns = data.candlestick_patterns.length + data.chart_patterns.length;
                    const countElement = document.getElementById('patternCountCompact');
                    if (countElement) {
                        countElement.textContent = `${totalPatterns}`;
                    }

                    // Update candlestick patterns (compact)
                    updateCandlestickPatternsCompact(data.candlestick_patterns);

                    // Update indicator signals (compact)
                    updateIndicatorSignalsCompact(data.indicators.signals);
                })
                .catch(e => console.error('Pattern update failed:', e));
        }

        function updateCandlestickPatternsCompact(patterns) {
            const container = document.getElementById('candlestickPatternsCompact');

            if (!patterns || patterns.length === 0) {
                container.innerHTML = `
                    <p style="color: var(--color-text-tertiary); text-align: center; padding: var(--space-4) 0; font-size: var(--text-xs);">
                        No patterns
                    </p>
                `;
                return;
            }

            let html = '';
            patterns.forEach(pattern => {
                const icon = getPatternIcon(pattern.type);
                const typeClass = pattern.type.includes('bullish') ? 'bullish' :
                                 pattern.type.includes('bearish') ? 'bearish' : 'indecision';

                html += `
                    <div class="pattern-compact pattern-compact--${sanitizeHTML.escape(typeClass)}">
                        <span class="pattern-icon">${sanitizeHTML.escape(icon)}</span>
                        <div class="pattern-compact-info">
                            <div class="pattern-compact-name">${sanitizeHTML.escape(pattern.name.replace(/_/g, ' '))}</div>
                        </div>
                        <span class="pattern-compact-confidence">${sanitizeHTML.escape(String(pattern.confidence))}%</span>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        function getPatternIcon(type) {
            if (type.includes('bullish')) return '';
            if (type.includes('bearish')) return '';
            return '';
        }

        function updateIndicatorSignalsCompact(signals) {
            const container = document.getElementById('indicatorSignalsCompact');

            if (!signals || Object.keys(signals).length === 0) {
                container.innerHTML = `
                    <p style="color: var(--color-text-tertiary); text-align: center; padding: var(--space-4) 0; font-size: var(--text-xs);">
                        No signals
                    </p>
                `;
                return;
            }

            let html = '';
            for (const [name, signal] of Object.entries(signals)) {
                const signalType = getSignalType(signal);
                html += `
                    <div class="indicator-compact indicator-compact--${sanitizeHTML.escape(signalType)}">
                        <span class="indicator-compact-name">${sanitizeHTML.escape(name)}</span>
                        <div class="indicator-compact-value">
                            <span class="indicator-compact-text">${sanitizeHTML.escape(signal.replace(/_/g, ' ').split(' ')[0])}</span>
                            <span class="signal-dot signal-dot--${sanitizeHTML.escape(signalType)}"></span>
                        </div>
                    </div>
                `;
            }

            container.innerHTML = html;
        }

        function getSignalType(signal) {
            if (signal.includes('buy') || signal.includes('bullish')) return 'bullish';
            if (signal.includes('sell') || signal.includes('bearish')) return 'bearish';
            return 'neutral';
        }

        function updateStatValue(id, value) {
            const el = document.getElementById(id);
            el.textContent = '' + value.toFixed(2);
            if (value > 0) {
                el.style.color = '#10B981';
            } else if (value < 0) {
                el.style.color = '#EF4444';
            } else {
                el.style.color = '#F9FAFB';
            }
        }

        function updatePositions(positions) {
            const content = document.getElementById('positionsContent');
            if (!positions || positions.length === 0) {
                content.innerHTML = '<p style="color: var(--color-text-secondary); text-align: center; padding: var(--space-8) 0; font-size: var(--text-sm);">No active positions</p>';
                return;
            }

            let html = '<table><thead><tr><th>Symbol</th><th>Qty</th><th>Price</th><th>P&L</th></tr></thead><tbody>';
            positions.forEach(p => {
                const pnl = (p.current_price - p.avg_price) * p.quantity;
                const pnlClass = pnl > 0 ? 'positive' : 'negative';
                html += `<tr>
                    <td class="table-symbol">${sanitizeHTML.escape(p.symbol)}</td>
                    <td>${sanitizeHTML.escape(String(p.quantity))}</td>
                    <td>${sanitizeHTML.escape(p.current_price.toFixed(2))}</td>
                    <td class="table-pnl table-pnl--${sanitizeHTML.escape(pnlClass)}">${sanitizeHTML.escape(pnl.toFixed(2))}</td>
                </tr>`;
            });
            html += '</tbody></table>';
            content.innerHTML = html;
        }

        function updateTrades(trades) {
            const content = document.getElementById('tradesContent');
            if (!trades || trades.length === 0) {
                content.innerHTML = '<p style="color: var(--color-text-secondary); text-align: center; padding: var(--space-8) 0; font-size: var(--text-sm);">No trades yet</p>';
                return;
            }

            let html = '<table><thead><tr><th>Time</th><th>Symbol</th><th>Side</th><th>P&L</th></tr></thead><tbody>';
            trades.slice(-5).reverse().forEach(t => {
                const pnlClass = t.pnl > 0 ? 'positive' : 'negative';
                html += `<tr>
                    <td>${sanitizeHTML.escape(new Date(t.timestamp).toLocaleTimeString())}</td>
                    <td class="table-symbol">${sanitizeHTML.escape(t.symbol)}</td>
                    <td>${sanitizeHTML.escape(t.action)}</td>
                    <td class="table-pnl table-pnl--${sanitizeHTML.escape(pnlClass)}">${sanitizeHTML.escape(t.pnl.toFixed(2))}</td>
                </tr>`;
            });
            html += '</tbody></table>';
            content.innerHTML = html;
        }

        function loadLogs() {
            fetch(`/api/logs?type=${currentLogType}&lines=20`)
                .then(r => r.json())
                .then(data => {
                    const viewer = document.getElementById('logViewer');
                    if (!data.logs || data.logs.length === 0) return;

                    let html = '';
                    data.logs.forEach(log => {
                        if (log.timestamp) {
                            html += `<div class="log-entry">
                                <span class="log-timestamp">${sanitizeHTML.escape(new Date(log.timestamp).toLocaleTimeString())}</span>
                                <span class="log-level log-level--${sanitizeHTML.escape(log.level)}">[${sanitizeHTML.escape(log.level)}]</span>
                                <span>${sanitizeHTML.escape(log.message)}</span>
                            </div>`;
                        }
                    });
                    viewer.innerHTML = html;
                })
                .catch(e => console.error('Log load failed:', e));
        }

        function switchLogTab(type) {
            currentLogType = type;
            const buttons = document.querySelectorAll('.card__header .chart-tabs .chart-tab');
            buttons.forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            loadLogs();
        }

        function showAlert(message, type) {
            const area = document.getElementById('alertArea');
            const alert = document.createElement('div');
            alert.className = `alert alert-${type} fade-in`;
            alert.innerHTML = `
                <i data-lucide="${type === 'success' ? 'check-circle' : type === 'error' ? 'x-circle' : 'alert-triangle'}" class="icon-18" aria-hidden="true"></i>
                <span>${sanitizeHTML.escape(message)}</span>
            `;
            area.appendChild(alert);
            lucide.createIcons();
            setTimeout(() => alert.remove(), 5000);
        }

        function startBot() {
            const mode = document.getElementById('modeSelect').value;
            if (mode === 'live' && !confirm(' Start LIVE trading with real money?')) return;

            fetch('/api/start', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({mode})
            })
            .then(r => r.json())
            .then(data => {
                if (data.success) showAlert(data.message, 'success');
                else showAlert(data.error, 'error');
                updateDashboard();
            });
        }

        function pauseBot() {
            fetch('/api/pause', {method: 'POST'})
                .then(r => r.json())
                .then(data => {
                    showAlert(data.success ? data.message : data.error, data.success ? 'success' : 'error');
                    updateDashboard();
                });
        }

        function stopBot() {
            fetch('/api/stop', {method: 'POST'})
                .then(r => r.json())
                .then(data => {
                    showAlert(data.success ? data.message : data.error, data.success ? 'success' : 'error');
                    updateDashboard();
                });
        }

        function emergencyStop() {
            if (!confirm(' EMERGENCY STOP\n\nThis will cancel all orders and close all positions!\n\nAre you sure?')) return;

            fetch('/api/emergency-stop', {method: 'POST'})
                .then(r => r.json())
                .then(data => {
                    showAlert(data.success ? data.message : data.error, data.success ? 'warning' : 'error');
                    updateDashboard();
                });
        }

        // Mobile sidebar toggle
        function toggleMobileSidebar() {
            const sidebar = document.querySelector('.sidebar');
            const hamburger = document.getElementById('hamburgerBtn');
            sidebar.classList.toggle('mobile-hidden');
            hamburger.classList.toggle('active');
        }

        // ==================== Watchlist & Recommendations Functions ====================

        // Toggle watchlist panel
        function toggleWatchlist() {
            const content = document.getElementById('watchlistContent');
            const toggleText = document.getElementById('watchlistToggleText');
            content.classList.toggle('collapsed');
            toggleText.textContent = content.classList.contains('collapsed') ? ' WATCHLIST' : ' WATCHLIST';
        }

        // Load watchlist
        function loadWatchlist() {
            fetch('/api/watchlist')
                .then(r => r.json())
                .then(data => {
                    if (!data.success) {
                        console.error('Failed to load watchlist:', data.error);
                        return;
                    }

                    const watchlistList = document.getElementById('watchlistList');
                    const watchlistCount = document.getElementById('watchlistCount');

                    watchlistCount.textContent = data.count;

                    if (data.count === 0) {
                        watchlistList.innerHTML = '<div class="loading-spinner">No stocks in watchlist. Add one above!</div>';
                        return;
                    }

                    watchlistList.innerHTML = data.watchlist.map(stock => `
                        <div class="watchlist-item">
                            <div class="watchlist-item-info">
                                <div class="watchlist-symbol">${sanitizeHTML.escape(stock.symbol)}</div>
                                <div class="watchlist-price">
                                    ${sanitizeHTML.escape(String(stock.current_price))}
                                    <span class="watchlist-change ${stock.price_change >= 0 ? 'positive' : 'negative'}">
                                        ${stock.price_change >= 0 ? '+' : ''}${sanitizeHTML.escape(stock.price_change_pct.toFixed(2))}%
                                    </span>
                                </div>
                                ${stock.pattern_badge ? `
                                    <div class="watchlist-pattern-badge bullish">
                                        ${sanitizeHTML.escape(stock.pattern_badge.name)} (${sanitizeHTML.escape(String(stock.pattern_badge.confidence))}%)
                                    </div>
                                ` : ''}
                            </div>
                            <div class="watchlist-item-actions">
                                <button class="watchlist-remove-btn" onclick="removeFromWatchlist('${sanitizeHTML.escape(stock.symbol)}')">
                                    Remove
                                </button>
                            </div>
                        </div>
                    `).join('');

                    lucide.createIcons();
                })
                .catch(err => console.error('Error loading watchlist:', err));
        }

        // Add to watchlist
        function addToWatchlist() {
            const input = document.getElementById('addStockInput');
            const symbol = input.value.trim().toUpperCase();

            if (!symbol) {
                showAlert('Please enter a stock symbol', 'error');
                return;
            }

            fetch('/api/watchlist/add', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({symbol: symbol})
            })
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    showAlert(`${symbol} added to watchlist`, 'success');
                    input.value = '';
                    loadWatchlist();
                } else {
                    showAlert(data.error, 'error');
                }
            })
            .catch(err => {
                console.error('Error adding to watchlist:', err);
                showAlert('Failed to add stock', 'error');
            });
        }

        // Remove from watchlist
        function removeFromWatchlist(symbol) {
            fetch('/api/watchlist/remove', {
                method: 'DELETE',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({symbol: symbol})
            })
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    showAlert(`${symbol} removed from watchlist`, 'success');
                    loadWatchlist();
                } else {
                    showAlert(data.error, 'error');
                }
            })
            .catch(err => {
                console.error('Error removing from watchlist:', err);
                showAlert('Failed to remove stock', 'error');
            });
        }

        // Load top picks
        function loadTopPicks() {
            fetch('/api/recommendations/today?limit=5')
                .then(r => r.json())
                .then(data => {
                    if (!data.success) {
                        console.error('Failed to load recommendations:', data.error);
                        return;
                    }

                    const topPicksList = document.getElementById('topPicksList');

                    if (data.count === 0) {
                        topPicksList.innerHTML = '<div class="loading-spinner">No recommendations available today. Try refreshing!</div>';
                        return;
                    }

                    topPicksList.innerHTML = data.recommendations.map(pick => `
                        <div class="top-pick-item">
                            <div class="top-pick-header">
                                <span class="top-pick-symbol">${sanitizeHTML.escape(pick.symbol)}</span>
                                <span class="top-pick-confidence">${sanitizeHTML.escape(String(pick.confidence))}%</span>
                            </div>
                            <div class="top-pick-details">
                                <div class="top-pick-detail">
                                    <span class="top-pick-detail-label">Entry</span>
                                    <span class="top-pick-detail-value">${sanitizeHTML.escape(String(pick.entry_price))}</span>
                                </div>
                                <div class="top-pick-detail">
                                    <span class="top-pick-detail-label">Pattern</span>
                                    <span class="top-pick-detail-value">${sanitizeHTML.escape(pick.pattern_name.replace(/_/g, ' '))}</span>
                                </div>
                            </div>
                            <div class="top-pick-pattern">
                                 ${sanitizeHTML.escape(pick.pattern_type.charAt(0).toUpperCase() + pick.pattern_type.slice(1))} Signal
                            </div>
                        </div>
                    `).join('');

                    lucide.createIcons();
                })
                .catch(err => console.error('Error loading top picks:', err));
        }

        // Refresh top picks
        function refreshTopPicks() {
            const topPicksList = document.getElementById('topPicksList');
            topPicksList.innerHTML = '<div class="loading-spinner">Refreshing recommendations...</div>';

            fetch('/api/recommendations/today?limit=5&refresh=true')
                .then(r => r.json())
                .then(data => {
                    if (!data.success) {
                        showAlert('Failed to refresh recommendations', 'error');
                        return;
                    }

                    loadTopPicks();
                    showAlert(`Refreshed ${data.count} recommendations`, 'success');
                })
                .catch(err => {
                    console.error('Error refreshing picks:', err);
                    showAlert('Failed to refresh recommendations', 'error');
                });
        }

        // Keyboard Navigation Support
        document.addEventListener('keydown', (e) => {
            // Escape key - Close modals/alerts
            if (e.key === 'Escape') {
                const alertArea = document.getElementById('alertArea');
                if (alertArea && alertArea.children.length > 0) {
                    alertArea.innerHTML = '';
                }
            }

            // Arrow keys for tab navigation (when not in input)
            if (!['INPUT', 'TEXTAREA', 'SELECT'].includes(e.target.tagName)) {
                // Chart tabs (performance overview)
                const chartTabs = document.querySelectorAll('.chart-tabs .chart-tab');
                const activeChartTab = document.querySelector('.chart-tabs .chart-tab.active');

                if (e.key === 'ArrowLeft' && activeChartTab) {
                    e.preventDefault();
                    const index = Array.from(chartTabs).indexOf(activeChartTab);
                    if (index > 0) {
                        chartTabs[index - 1].click();
                        chartTabs[index - 1].focus();
                    }
                }

                if (e.key === 'ArrowRight' && activeChartTab) {
                    e.preventDefault();
                    const index = Array.from(chartTabs).indexOf(activeChartTab);
                    if (index < chartTabs.length - 1) {
                        chartTabs[index + 1].click();
                        chartTabs[index + 1].focus();
                    }
                }

                // Ctrl/Cmd + E - Emergency Stop
                if ((e.ctrlKey || e.metaKey) && e.key === 'e') {
                    e.preventDefault();
                    if (confirm(' Emergency Stop: Cancel all orders and close positions?')) {
                        emergencyStop();
                    }
                }

                // Ctrl/Cmd + S - Start Bot
                if ((e.ctrlKey || e.metaKey) && e.key === 's') {
                    e.preventDefault();
                    startBot();
                }

                // Ctrl/Cmd + P - Pause Bot
                if ((e.ctrlKey || e.metaKey) && e.key === 'p') {
                    e.preventDefault();
                    pauseBot();
                }
            }
        });

        // Allow Enter key for adding stock
        document.addEventListener('DOMContentLoaded', () => {
            const input = document.getElementById('addStockInput');
            if (input) {
                input.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        addToWatchlist();
                    }
                });
            }

            // Make chart tabs keyboard accessible
            const chartTabs = document.querySelectorAll('.chart-tabs .chart-tab');
            chartTabs.forEach((tab, index) => {
                tab.setAttribute('tabindex', '0');
                tab.setAttribute('role', 'tab');
                tab.setAttribute('aria-selected', tab.classList.contains('active') ? 'true' : 'false');

                tab.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter' || e.key === ' ') {
                        e.preventDefault();
                        tab.click();
                    }
                });
            });

            // Make account selector keyboard accessible
            const accountSelector = document.querySelector('.topbar__account');
            if (accountSelector) {
                accountSelector.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter' || e.key === ' ') {
                        e.preventDefault();
                        // Trigger account selector (you can add dropdown logic here)
                        console.log('Account selector clicked');
                    }
                });
            }
        });

        // Initialize
        window.onload = () => {
            initCandlestickChart(); // Initialize candlestick chart
            initChart(); // Initialize performance chart
            updateDashboard();
            loadLogs();
            updatePatterns(); // Load pattern recognition data
            loadWatchlist(); // Load watchlist
            loadTopPicks(); // Load top picks

            // Hide sidebar on mobile by default
            if (window.innerWidth <= 768) {
                document.querySelector('.sidebar').classList.add('mobile-hidden');
            }

            setInterval(() => {
                updateDashboard();
                loadLogs();
                updatePatterns(); // Refresh pattern data every 2 seconds
                loadWatchlist(); // Refresh watchlist every 2 seconds
                // Note: Chart updates are handled within updateCandlestickData
                // Note: Top picks are NOT auto-refreshed (manual refresh only)
            }, 2000);
        };

        // Dropdown Menu System
        function toggleDropdown(dropdownId) {
            const dropdown = document.getElementById(dropdownId);
            const allDropdowns = document.querySelectorAll('.dropdown__menu');

            // Close all other dropdowns
            allDropdowns.forEach(d => {
                if (d.id !== dropdownId) {
                    d.classList.remove('show');
                }
            });

            // Toggle current dropdown
            dropdown.classList.toggle('show');
        }

        // Close dropdowns when clicking outside
        document.addEventListener('click', function(event) {
            if (!event.target.closest('.dropdown')) {
                document.querySelectorAll('.dropdown__menu').forEach(dropdown => {
                    dropdown.classList.remove('show');
                });
            }
        });

        // Set active menu item based on current page
        function setActiveMenuItem() {
            const currentPath = window.location.pathname;
            document.querySelectorAll('.dropdown__item').forEach(item => {
                if (item.getAttribute('href') === currentPath) {
                    item.classList.add('active');
                } else {
                    item.classList.remove('active');
                }
            });
        }

        // Load notifications
        function loadNotifications() {
            // This will be connected to real API later
            const notifications = [
                {
                    type: 'success',
                    title: 'Trade Executed',
                    message: 'Bought 10 shares of RELIANCE at 2,450',
                    time: '2 minutes ago'
                },
                {
                    type: 'info',
                    title: 'Pattern Detected',
                    message: 'Hammer pattern detected on NIFTY50 5m chart',
                    time: '15 minutes ago'
                }
            ];

            const notificationList = document.getElementById('notificationList');
            const notificationCount = document.getElementById('notification-count');

            if (notifications.length === 0) {
                notificationList.innerHTML = '<div class="notification-empty">No new notifications</div>';
                notificationCount.textContent = '0';
                return;
            }

            notificationCount.textContent = notifications.length;

            notificationList.innerHTML = notifications.map(notif => `
                <div class="notification-item">
                    <div class="notification-item__icon notification-item__icon--${notif.type}">
                        <i data-lucide="${notif.type === 'success' ? 'check-circle' : 'info'}" class="icon-16"></i>
                    </div>
                    <div class="notification-item__content">
                        <div class="notification-item__title">${notif.title}</div>
                        <div class="notification-item__message">${notif.message}</div>
                        <div class="notification-item__time">${notif.time}</div>
                    </div>
                </div>
            `).join('');

            // Re-initialize Lucide icons
            if (window.lucide) {
                lucide.createIcons();
            }
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            setActiveMenuItem();
            loadNotifications();
        });

    </script>
</body>
</html>
